C51 COMPILER V7.50   MAIN                                                                  09/06/2018 23:51:11 PAGE 1   


C51 COMPILER V7.50, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*********************************************************************************************
   2          程序名： 　　 AD/DA转换函数
   3          编写人： 　　 Jaden
   4          编写时间：　　2018年9月03日
   5          硬件支持：　　STC12C2052AD 12MHz
   6          接口说明：　　  
   7          修改日志：　　
   8          　　NO.1-                                                               
   9          /*********************************************************************************************
  10          说明：
  11          
  12          /*********************************************************************************************/
  13          #include<reg51.h>
  14          #define uchar unsigned char
  15          #define uint unsigned int
  16          
  17          uchar AD_read_start(void);
  18          void AD_write_start(void);
  19          void I2C_send_ask(uchar A);
  20          uchar I2C_read_dat(void);
  21          void I2C_send_dat(uchar dat);
  22          void I2C_stop();
  23          void I2C_start();
  24          void DELAY_US(uint T);
  25          void DELAY_MS(uint T);
  26          void DA_start(uchar DA_Number);
  27          
  28          uchar unmber1, number2;
  29          uint AD_Number;
  30          
  31          sbit I2C_SDA = P2^0;
  32          sbit I2C_SCL = P2^1;
  33          /*********************************************************************************************
  34          函数名：毫秒级CPU延时函数
  35          调  用：DELAY_MS (?);
  36          参  数：1~65535（参数不可为0）
  37          返回值：无
  38          结  果：占用CPU方式延时与参数数值相同的毫秒时间
  39          备  注：应用于1T单片机时i<600，应用于12T单片机时i<125
  40          /*********************************************************************************************/
  41          void DELAY_MS(uint T)
  42          {
  43   1              uchar i;
  44   1              while(T-- !=0)
  45   1              {
  46   2                      for(i=0;i<600;i++);
  47   2              }
  48   1      }
  49          
  50          /*********************************************************************************************
  51          函数名：微秒级CPU延时函数
  52          调  用：DELAY_US (?);
  53          参  数：1~65535（参数不可为0）
  54          返回值：无
  55          结  果：占用CPU方式延时与参数数值相同的毫秒时间
C51 COMPILER V7.50   MAIN                                                                  09/06/2018 23:51:11 PAGE 2   

  56          备  注:
  57          /*********************************************************************************************/
  58          void DELAY_US(uint T)
  59          {
  60   1              while(T-- !=0);
  61   1      }
  62          
  63          /*********************************************************************************************
  64          函数名：I2C开启函数
  65          调  用：I2C_start();
  66          参  数：
  67          返回值：无
  68          结  果：
  69          备  注：
  70          /*********************************************************************************************/
  71          void I2C_start()
  72          {
  73   1              I2C_SDA =1;
  74   1              DELAY_US(4);
  75   1              I2C_SCL =1;
  76   1              DELAY_US(4);
  77   1              I2C_SDA =0;
  78   1              DELAY_US(4);
  79   1      }
  80          
  81          /*********************************************************************************************
  82          函数名：I2C关闭函数
  83          调  用：I2C_stop();
  84          参  数：
  85          返回值：无
  86          结  果：
  87          备  注：
  88          /*********************************************************************************************/
  89          void I2C_stop()
  90          {
  91   1              I2C_SDA =0;
  92   1              DELAY_US(4);
  93   1              I2C_SCL =1;
  94   1              DELAY_US(4);
  95   1              I2C_SDA =1;
  96   1              DELAY_US(4);
  97   1      }
  98          
  99          /*********************************************************************************************
 100          函数名：I2C发送数据
 101          调  用：I2C_send_byte(uchar dat);
 102          参  数：
 103          返回值：
 104          结  果：
 105          备  注：
 106          /*********************************************************************************************/
 107          void I2C_send_dat(uchar dat)
 108          {
 109   1              uchar i,j;
 110   1              I2C_SCL =0;
 111   1              for(i=0;i<8;i++)
 112   1              {
 113   2      
 114   2                      I2C_SDA =(bit)(dat & 0x80);
 115   2                      dat=dat<<1;
 116   2                      I2C_SCL =1;
 117   2                      DELAY_US(4);
C51 COMPILER V7.50   MAIN                                                                  09/06/2018 23:51:11 PAGE 3   

 118   2                      I2C_SCL=0;
 119   2                      DELAY_US(4);
 120   2              }
 121   1              I2C_SDA=1;
 122   1              DELAY_US(4);
 123   1              I2C_SCL=1;
 124   1              DELAY_US(4);
 125   1              j = 0;
 126   1              while(I2C_SDA==1 && j<200) j++;
 127   1              DELAY_US(4);
 128   1              I2C_SCL=0;
 129   1              DELAY_US(4);
 130   1      }
 131          /*********************************************************************************************
 132          函数名：I2C读数据
 133          调  用：uchar I2C_read_dat(void);
 134          参  数：
 135          返回值：无
 136          结  果：
 137          备  注：
 138          /*********************************************************************************************/
 139          uchar I2C_read_dat(void)
 140          {
 141   1              uchar i,rdat;
 142   1              rdat=0x00;
 143   1              I2C_SDA=1;
 144   1              for(i=0;i<8;i++)
 145   1              {
 146   2                      I2C_SCL=0;              
 147   2                      rdat=rdat<<1;
 148   2                      DELAY_US(4);
 149   2                      I2C_SCL=1;
 150   2                      DELAY_US(4);
 151   2                      if(I2C_SDA==1)
 152   2                      {
 153   3                              rdat = rdat|0x01;
 154   3                      }
 155   2                      I2C_SCL=0;
 156   2                      DELAY_US(4);
 157   2              }
 158   1              return rdat;
 159   1      }
 160          
 161          /*********************************************************************************************
 162          函数名：发送应答位:1标示发送应答，0标示不发送应答；
 163          调  用：I2C_send_ask(uchar A)
 164          参  数：
 165          返回值：无
 166          结  果：
 167          备  注：
 168          /*********************************************************************************************/
 169          void I2C_send_ask(uchar A)
 170          {
 171   1              if(A==0)
 172   1              {
 173   2                      I2C_SDA=1;
 174   2                      DELAY_US(4);
 175   2                      I2C_SCL=1;
 176   2                      DELAY_US(4);
 177   2                      I2C_SCL=0;
 178   2                      DELAY_US(4);
 179   2              }else
C51 COMPILER V7.50   MAIN                                                                  09/06/2018 23:51:11 PAGE 4   

 180   1              {
 181   2      
 182   2                      I2C_SDA=0;
 183   2                      DELAY_US(4);
 184   2                      I2C_SCL=1;
 185   2                      DELAY_US(4);
 186   2                      I2C_SCL=0;
 187   2                      DELAY_US(4);
 188   2              }
 189   1      
 190   1              
 191   1      }
 192          
 193          /*********************************************************************************************
 194          函数名：开启AD转换
 195          调  用：AD_write_start(void);
 196          参  数：
 197          返回值：无
 198          结  果：
 199          备  注：
 200          /*********************************************************************************************/
 201          void AD_write_start(void)
 202          {
 203   1              I2C_start();
 204   1              I2C_send_dat(0x90);
 205   1              I2C_send_dat(0x40);
 206   1              I2C_stop();
 207   1      }
 208          
 209          /*********************************************************************************************
 210          函数名：开启AD转换
 211          调  用：uchar AD_write_start(void);
 212          参  数：
 213          返回值：无
 214          结  果：
 215          备  注：
 216          /*********************************************************************************************/
 217          uchar AD_read_start(void)
 218          {
 219   1              I2C_start();
 220   1              I2C_send_dat(0x91);
 221   1              unmber1=I2C_read_dat();
 222   1              I2C_send_ask(1);
 223   1              I2C_stop();
 224   1              return(unmber1);
 225   1      }
 226          
 227          
 228          /*********************************************************************************************
 229          函数名：开启DA转换
 230          调  用：DA_start(uchar D);
 231          参  数：
 232          返回值：无
 233          结  果：
 234          备  注：
 235          /*********************************************************************************************/
 236          void DA_start(uchar DA_Number)
 237          {
 238   1              I2C_start();
 239   1              I2C_send_dat(0x90);
 240   1              I2C_send_dat(0x40);
 241   1              I2C_send_dat(DA_Number);
C51 COMPILER V7.50   MAIN                                                                  09/06/2018 23:51:11 PAGE 5   

 242   1              I2C_stop();
 243   1              
 244   1      }
 245          
 246          
 247          /*********************************************************************************************
 248          函数名：main()
 249          调  用：
 250          参  数：
 251          返回值：
 252          结  果：
 253          备  注：
 254          /*********************************************************************************************/
 255          
 256          void main()
 257          {
 258   1              while(1)
 259   1              {       
 260   2              //DA转换
 261   2              //DA_start(0Xaa);
 262   2      
 263   2              //AD转换AIN0
 264   2              AD_write_start();
 265   2              AD_Number=AD_read_start();
 266   2              P0=AD_Number;
 267   2              DELAY_MS(100);
 268   2      
 269   2              }
 270   1      
 271   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    266    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
